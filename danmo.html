<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ²»å…·è®¾è®¡æŸ¥è¯¢ç³»ç»Ÿ Â· è¡¨æ ¼&ç»Ÿè®¡</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --purple-1:#5b3ee4; --purple-2:#7a35ea;
      --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb;
      --green-1:#10b981; --green-2:#059669; --orange-1:#f59e0b; --orange-2:#d97706;
      --shadow: 0 8px 30px rgba(0,0,0,.08);
      --radius-xl: 20px;
    }
    body{margin:0;min-height:100vh;background:linear-gradient(125deg,#6a5ae8 0%,#7c3aed 100%);font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;color:#111827}
    .page{max-width:1380px;margin:0 auto;padding:24px}
    .hero{background:linear-gradient(135deg,var(--purple-1),var(--purple-2));padding:28px;border-radius:var(--radius-xl);box-shadow:var(--shadow);color:#fff;position:relative}
    .hero h1{margin:0 0 8px;font-size:28px;font-weight:700}
    .hero small{opacity:.9}

    .lang-switch{position:absolute;right:28px;top:28px;display:flex;gap:8px}
    .pill{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.18);color:#fff;font-weight:600;border:1px solid rgba(255,255,255,.25);cursor:pointer}
    .pill.active{background:#fff;color:#4b2df0}

    .card{margin-top:18px;background:var(--card);border-radius:var(--radius-xl);box-shadow:var(--shadow);padding:22px}
    .row{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:16px;align-items:center}
    .label{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600}

    .btn{height:40px;border:none;border-radius:12px;padding:0 14px;font-weight:700;color:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:6px;box-shadow:0 8px 18px rgba(0,0,0,.08);transition:.2s}
    .btn.green{background:linear-gradient(135deg,var(--green-1),var(--green-2))}
    .btn.orange{background:linear-gradient(135deg,var(--orange-1),var(--orange-2))}

    select{height:40px;width:100%;border:1px solid var(--line);border-radius:12px;padding:0 12px}

    .filter-block{margin-top:18px;border:1px solid var(--line);border-radius:16px;background:#fafafa;padding:16px}
    .tabs{display:grid;grid-template-columns:repeat(3,1fr);background:#eef2ff;border-radius:999px;overflow:hidden;margin-bottom:12px}
    .tab{padding:8px 12px;text-align:center;font-weight:700;color:#6d6ef9;cursor:pointer}
    .tab.active{background:var(--purple-1);color:#fff}

    .stats{margin-top:22px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .stat-box{background:#fff;border-radius:16px;padding:18px;box-shadow:var(--shadow);text-align:center}
    .stat-box h2{margin:0;font-size:28px;color:var(--purple-1)}
    .stat-box small{color:var(--muted);display:block;line-height:1.7}
    .stat-box .title{font-size:16px;font-weight:800;color:#374151;margin-bottom:8px}

    .charts-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
    .chart-box{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .chart-box h3{margin:0 0 12px;font-size:16px;color:#374151;text-align:center}
    .chart-box canvas{max-width:90% !important;height:240px!important;display:block;margin:0 auto}

    .grid{margin-top:22px;background:#fff;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    thead th{position:sticky;top:0;background:linear-gradient(135deg,#4f46e5 0%, #7c3aed 100%);color:#fff;text-align:left;padding:10px 8px}
    tbody td{padding:8px;border-top:1px solid var(--line)}
    tbody tr:nth-child(even){background:#f9fafb}
    tbody tr:hover{background:#f1f5f9}
    .empty{padding:40px;text-align:center;color:#9ca3af}

    @media (max-width:900px){.row{grid-template-columns:1fr}.charts-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="page">
    <div class="hero">
      <div class="lang-switch">
        <button class="pill active" data-lang="zh">ä¸­æ–‡</button>
        <button class="pill" data-lang="en">EN</button>
        <button class="pill" data-lang="th">TH</button>
      </div>
      <h1 data-i18n="title">æ²»å…·è®¾è®¡æŸ¥è¯¢ç³»ç»Ÿ</h1>
      <small data-i18n="subtitle">Fixture Design Query System</small>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="label">ğŸ“¤ ä¸Šä¼ Excelæ–‡ä»¶</div>
          <input id="file" type="file" accept=".xlsx,.xls" style="display:none" />
          <label for="file" class="btn green">ğŸ“ é€‰æ‹©Excelæ–‡ä»¶</label>
          <button class="btn" style="background:#6366f1" id="demoBtn">ğŸ§ª ç¤ºä¾‹</button>
        </div>
        <div>
          <div class="label">ğŸ‘¤ è®¾è®¡äººå‘˜</div>
          <select id="designerSelect"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div>
          <div class="label">ğŸ·ï¸ å›¾çº¸åˆ†ç±»</div>
          <select id="categorySelect"><option value="">å…¨éƒ¨</option></select>
        </div>
      </div>

      <div class="filter-block">
        <div class="label">ğŸ“… é‚®ä»¶æ—¶é—´ç­›é€‰</div>
        <div class="tabs">
          <div class="tab active" data-mode="year">æŒ‰å¹´åº¦</div>
          <div class="tab" data-mode="quarter">æŒ‰å­£åº¦</div>
          <div class="tab" data-mode="month">æŒ‰æœˆä»½</div>
        </div>
        <div id="timeControls"></div>
      </div>

      <div style="margin-top:12px;text-align:center">
        <button class="btn orange" id="exportBtn">â¬‡ï¸ å¯¼å‡ºç»“æœ</button>
      </div>
    </div>

    <div class="stats" id="stats"></div>
    <div class="charts-row">
      <div class="chart-box"><h3>å›¾çº¸åˆ†ç±»å æ¯”</h3><canvas id="pieChart"></canvas></div>
      <div class="chart-box"><h3>è®¾è®¡äººå‘˜å æ¯”</h3><canvas id="barChart"></canvas></div>
    </div>

    <div class="grid">
      <div class="table-wrap">
        <table id="table"><thead><tr id="thead"></tr></thead><tbody id="tbody">
          <tr class="empty"><td colspan="100%">è¯·å…ˆä¸Šä¼  Excel æˆ–è½½å…¥ç¤ºä¾‹</td></tr>
        </tbody></table>
      </div>
    </div>
  </div>

  <script>
    let rawRows = [], headers = [], fieldMap = { designer: null, category: null, date: null };

    // âœ… åˆ†ç±»å½’å¹¶ï¼šç¡®ä¿â€œæ±‡æ€»å£å¾„â€å’Œå›¾äºŒä¸€è‡´ï¼ˆä»…è¾“å‡º 4 ç±»ï¼‰
    function normalizeCategory(v) {
      const val = String(v || '').trim();
      if (!val) return 'ç©ºç™½';

      // ä½ å¯ä»¥æŒ‰ä½ çš„ Excel å®é™…å†™æ³•ç»§ç»­è¡¥å……è§„åˆ™
      if (/æ²»å…·å‡çº§|å‡çº§|æ”¹é€ |æ”¹å–„|ä¿®æ”¹|å˜æ›´/i.test(val)) return 'æ²»å…·å‡çº§';
      if (/æ–°æ²»å…·|æ–°è®¾è®¡|æ–°ä½œ|æ–°è¦|æ–°å¢|æ–°å¼€|æ–°é–‹|æ–°/i.test(val)) return 'æ–°æ²»å…·è®¾è®¡';
      if (/æ—§æ²»å…·å¤åˆ¶|å¤åˆ¶|å¤åˆ»|æ‹·è´|copy|copying/i.test(val)) return 'æ—§æ²»å…·å¤åˆ¶';

      // ä¸åœ¨å£å¾„å†…çš„ï¼Œç»Ÿä¸€ä¸¢åˆ°â€œç©ºç™½â€æˆ–â€œå…¶ä»–â€ï¼ˆå¦‚æœä½ ä¸æƒ³å‡ºç°â€œå…¶ä»–â€ï¼Œå°±åˆ«ç”¨å®ƒï¼‰
      // è¿™é‡ŒæŒ‰ä½ çš„è¦æ±‚ï¼šåªè¦å’Œå›¾äºŒä¸€è‡´ -> ä¸é¢å¤–æ–°å¢ç±»åˆ«
      return 'ç©ºç™½';
    }

    function guessFields(hdrs) {
      const h = hdrs.map(x => String(x).toLowerCase());
      fieldMap.designer = hdrs[h.findIndex(n => n.includes('è®¾è®¡') || n.includes('designer'))] || null;
      fieldMap.category = hdrs[h.findIndex(n => n.includes('åˆ†ç±»') || n.includes('category'))] || null;
      fieldMap.date     = hdrs[h.findIndex(n => n.includes('æ—¶é—´') || n.includes('date'))] || null;
    }

    function renderTable(rows) {
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      if (!rows.length) {
        thead.innerHTML = '';
        tbody.innerHTML = '<tr class="empty"><td colspan=100%>æš‚æ— æ•°æ®</td></tr>';
        updateStats(rows);
        return;
      }
      headers = Object.keys(rows[0]);
      thead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
      tbody.innerHTML = rows.map(r => `<tr>${headers.map(h => `<td>${r[h] || ''}</td>`).join('')}</tr>`).join('');
      updateStats(rows);
    }

    function sheetToJson(wb) {
      const ws = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(ws, { defval: '', raw: false });
    }

    document.getElementById('file').addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      const fr = new FileReader();
      fr.onload = ev => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
        rawRows = sheetToJson(wb);
        init();
      };
      fr.readAsArrayBuffer(f);
    });

    const DEMO = [
      { ç¼–å·: 'OB-001', è®¾è®¡äººå‘˜: 'å¼ ä¸‰', å›¾çº¸åˆ†ç±»: 'æ²»å…·å‡çº§', é‚®ä»¶æ—¶é—´: '2025-07-01', éœ€æ±‚: 'å¤¹å…·A' },
      { ç¼–å·: 'OB-002', è®¾è®¡äººå‘˜: 'æå››', å›¾çº¸åˆ†ç±»: 'æ–°æ²»å…·è®¾è®¡', é‚®ä»¶æ—¶é—´: '2025-09-05', éœ€æ±‚: 'å¤¹å…·B' },
      { ç¼–å·: 'OB-003', è®¾è®¡äººå‘˜: 'ç‹äº”', å›¾çº¸åˆ†ç±»: 'æ—§æ²»å…·å¤åˆ¶', é‚®ä»¶æ—¶é—´: '2024-12-15', éœ€æ±‚: 'å¤¹å…·C' },
      { ç¼–å·: 'OB-004', è®¾è®¡äººå‘˜: 'å¼ ä¸‰', å›¾çº¸åˆ†ç±»: '', é‚®ä»¶æ—¶é—´: '2025-10-02', éœ€æ±‚: 'å¤¹å…·D' }
    ];
    document.getElementById('demoBtn').onclick = () => { rawRows = DEMO.slice(); init(); };

    function init() {
      if (!rawRows.length) { renderTable([]); return; }
      headers = Object.keys(rawRows[0]);
      guessFields(headers);
      fillDropdowns();
      buildTimeControls('year');
      applyFilters();
    }

    function unique(list) { return [...new Set(list.filter(Boolean))]; }

    function fillDropdowns() {
      const dSel = document.getElementById('designerSelect');
      const cSel = document.getElementById('categorySelect');

      const ds = unique(rawRows.map(r => r[fieldMap.designer] || ''));
      const cs = unique(rawRows.map(r => r[fieldMap.category] || ''));

      dSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + ds.map(v => `<option>${v}</option>`).join('');

      // åˆ†ç±»ä¸‹æ‹‰ä¿æŒâ€œåŸå§‹å€¼â€ï¼Œä¸å¼ºè¡Œå˜æˆ 4 ç±»ï¼ˆé¿å…ä½ ç­›é€‰æ—¶æ‰¾ä¸åˆ°åŸå€¼ï¼‰
      // ä½†ç»Ÿè®¡/å›¾è¡¨ä½¿ç”¨ normalizeCategory åšå½’å¹¶ï¼Œç¡®ä¿ä¸å›¾äºŒä¸€è‡´
      cSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + cs.map(v => `<option>${v}</option>`).join('');

      dSel.onchange = cSel.onchange = applyFilters;
    }

    document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      buildTimeControls(t.dataset.mode);
      applyFilters();
    });

    function buildTimeControls(mode) {
      // ä½ åŸä»£ç è¿™é‡Œåªåšäº† year ä¸‹æ‹‰ï¼ˆæœªå®ç°å­£åº¦/æœˆï¼‰ï¼Œä¿æŒä¸æ”¹é€»è¾‘
      document.getElementById('timeControls').innerHTML =
        '<select id="yearSel"><option value="">é€‰æ‹©å¹´åº¦</option></select>';
      document.getElementById('yearSel').onchange = applyFilters;
    }

    function applyFilters() {
      if (!rawRows.length) { renderTable([]); return; }
      let rows = rawRows.slice();

      const dVal = document.getElementById('designerSelect').value;
      const cVal = document.getElementById('categorySelect').value;

      if (dVal) rows = rows.filter(r => (r[fieldMap.designer] || '') === dVal);
      if (cVal) rows = rows.filter(r => (r[fieldMap.category] || '') === cVal);

      renderTable(rows);
    }

    function pct(part, total) {
      if (!total) return '0.0%';
      return (part * 100 / total).toFixed(1) + '%';
    }

    function updateStats(rows) {
      const statsBox = document.getElementById('stats');
      statsBox.innerHTML = '';

      const total = rows.length;
      const designers = unique(rows.map(r => r[fieldMap.designer] || ''));

      // âœ… å›ºå®šæ±‡æ€»å£å¾„ï¼ˆ4ç±»ï¼‰
      const cats = { 'æ²»å…·å‡çº§': 0, 'æ–°æ²»å…·è®¾è®¡': 0, 'æ—§æ²»å…·å¤åˆ¶': 0, 'ç©ºç™½': 0 };
      rows.forEach(r => {
        const c = normalizeCategory(fieldMap.category ? r[fieldMap.category] : '');
        cats[c] = (cats[c] || 0) + 1;
      });

      // åŸºç¡€ç»Ÿè®¡å¡ç‰‡ + åˆ†ç±»æ±‡æ€»å¡ç‰‡
      statsBox.innerHTML = `
        <div class='stat-box'>
          <h2>${total}</h2>
          <small>æ€»è®°å½•æ•°</small>
        </div>
        <div class='stat-box'>
          <h2>${designers.length}</h2>
          <small>è®¾è®¡äººå‘˜æ•°</small>
        </div>
        <div class='stat-box'>
          <div class="title">å›¾çº¸åˆ†ç±»æ±‡æ€»ï¼ˆä¸å›¾è¡¨ä¸€è‡´ï¼‰</div>
          <small>
            æ²»å…·å‡çº§ï¼š${cats['æ²»å…·å‡çº§']}ï¼ˆ${pct(cats['æ²»å…·å‡çº§'], total)}ï¼‰<br>
            æ–°æ²»å…·è®¾è®¡ï¼š${cats['æ–°æ²»å…·è®¾è®¡']}ï¼ˆ${pct(cats['æ–°æ²»å…·è®¾è®¡'], total)}ï¼‰<br>
            æ—§æ²»å…·å¤åˆ¶ï¼š${cats['æ—§æ²»å…·å¤åˆ¶']}ï¼ˆ${pct(cats['æ—§æ²»å…·å¤åˆ¶'], total)}ï¼‰<br>
            ç©ºç™½ï¼š${cats['ç©ºç™½']}ï¼ˆ${pct(cats['ç©ºç™½'], total)}ï¼‰
          </small>
        </div>
      `;

      // âœ… åˆ†ç±»åœ†ç¯å›¾ï¼ˆä¸æ±‡æ€»åŒæºï¼‰
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (window.pie) window.pie.destroy();

      window.pie = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(cats),
          datasets: [{
            data: Object.values(cats),
            backgroundColor: [
              '#3b82f6', // æ²»å…·å‡çº§
              '#8b5cf6', // æ–°æ²»å…·è®¾è®¡
              '#f59e0b', // æ—§æ²»å…·å¤åˆ¶
              '#9ca3af'  // ç©ºç™½
            ]
          }]
        },
        options: {
          responsive: true,
          cutout: '62%',
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const label = ctx.label || '';
                  const value = ctx.parsed || 0;
                  return `${label}ï¼š${value}ï¼ˆ${pct(value, total)}ï¼‰`;
                }
              }
            }
          }
        }
      });

      // è®¾è®¡äººå‘˜æŸ±çŠ¶å›¾ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰
      const people = {};
      rows.forEach(r => {
        const d = (fieldMap.designer ? r[fieldMap.designer] : '') || 'æœªçŸ¥';
        people[d] = (people[d] || 0) + 1;
      });

      const bctx = document.getElementById('barChart').getContext('2d');
      if (window.bar) window.bar.destroy();
      window.bar = new Chart(bctx, {
        type: 'bar',
        data: {
          labels: Object.keys(people),
          datasets: [{ label: 'æ•°é‡', data: Object.values(people), backgroundColor: '#6366f1' }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    document.getElementById('exportBtn').onclick = () => {
      const ws = XLSX.utils.table_to_sheet(document.getElementById('table'));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ç»“æœ');
      XLSX.writeFile(wb, 'æŸ¥è¯¢ç»“æœ.xlsx');
    };
  </script>
</body>
</html>
